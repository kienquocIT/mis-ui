{% load i18n define_action %}

<div class="drawer-config d-none" id="form-datetime">
    <form>
        {% assign_out_random nameIdx as rNameIdx %}
        <div class="form-group mb-3">
            <label for="{{ rNameIdx }}" class="form-label">
                {% trans 'Name of field' %}
            </label>
            <input type="text" class="form-control" id="{{ rNameIdx }}" name="name">
            <small class="form-text text-muted">
                {% trans 'Corresponds to a stored data field' %}.
                {% trans 'Employs this name to autofill form fields' %}.
            </small>
        </div>

        <hr/>

        {% include 'form/extends/base/title.html' %}
        {% include 'form/extends/base/instruction.html' %}
        {% include 'form/extends/base/size.html' %}
        {% include 'form/extends/base/placeholder.html' %}

        <hr/>

        {% assign_out_random formatOfValue as rFormatOfValue %}
        <div class="form-group mb-5">
            <label for="{{ rFormatOfValue }}" class="form-label">
                {% trans 'Display Format' %}
                <a class="ml-1" href="{% url 'FormKnowledgeView' %}#dateFormat,timeFormat" target="_blank"><i class="fa-solid fa-book"></i></a>
            </label>
            <input type="text" id="{{ rFormatOfValue }}" class="form-control" name="format" list="idx-date-format-suggestion" />
            <small class="form-text text-muted">
                <span>{% trans 'Day: 30' %} • {% trans 'Month: 01' %} • {% trans 'Year: 1900' %}</span>
            </small>
            <datalist id="idx-date-format-suggestion">
                <option value="l j F Y">Thứ năm 30 Tháng một 1990</option>
                <option value="l, j F Y">Thứ năm, 30 Tháng một 1990</option>
                <option value="l, \\ngà\\y j F Y">Thứ năm, ngày 30 Tháng một 1990</option>
                <option value="d-m-Y">30-01-1990</option>
                <option value="d/m/Y">30/01/1990</option>
                <option value="Y-m-d">1900-01-30</option>
                  <option value="Y/m/d">1900/01/30</option>
                <option value="m-d-Y">01-30-1990</option>
                <option value="m/d/Y">01/30/1990</option>
                <option value="F j, Y">Tháng một 30, 1900</option>
                <option value="j F Y">30 Tháng một 1900</option>
                <option value="Y, F j">1900, Tháng một 30</option>
            </datalist>
            <label class="form-text text-muted">{% trans 'Preview format with now' %}</label>
            <input type="text" class="form-control mt-1" readonly disabled id="previewDateFormat" />
        </div>

        {% assign_out_random typeInitValueIdx as rTypeInitValueIdx %}
        <div class="form-group mb-3">
            <label for="{{ rTypeInitValueIdx }}" class="form-label">{% trans 'Type of init value' %}</label>
            <select name="init_value_type" id="{{ rTypeInitValueIdx }}" class="input-radio-select">
                <option value="unset" selected>-</option>
                <option value="now">{% trans 'Now' %}</option>
                <option value="custom">{% trans 'Custom' %}</option>
            </select>
        </div>

        {% assign_out_random customInitValue as rCustomInitValue %}
        <div class="form-group mb-3" id="date-group-custom-init" style="display: none;">
            <label for="{{ rCustomInitValue }}">{% trans 'Initial value' %}</label>
            <input type="text" name="init_value_custom" class="form-control" id="{{ rCustomInitValue }}" />
        </div>

        <hr/>

        <div class="d-flex mb-3">
            <div style="flex: 1 1 calc(50% - 5px);margin-right: 5px;">
                {% assign_out_random datetimeMinValueIdx as rDatetimeMinValueIdx %}
                <label for="{{ rDatetimeMinValueIdx }}" class="form-label">{% trans 'Min' %}</label>
                <input type="text" class="form-control" name="min_value" id="{{ rDatetimeMinValueIdx }}" />
            </div>
            <div style="flex: 1 1 calc(50% - 5px);margin-left: 5px;">
                {% assign_out_random datetimeMaxValueIdx as rDatetimeMaxValueIdx %}
                <label for="{{ rDatetimeMaxValueIdx }}" class="form-label">{% trans 'Max' %}</label>
                <input type="text" class="form-control" name="max_value" id="{{ rDatetimeMaxValueIdx }}" />
            </div>
        </div>

        <hr/>

        {% include 'form/extends/base/validation.html' %}

        {% include 'form/extends/base/visibility.html' %}
    </form>
</div>

<script>
    $(document).ready(function (){
        const frm$ = $('#form-datetime');

        const previewFormat$ = frm$.find('#previewDateFormat');
        const inputFormat$ = frm$.find('#{{ rFormatOfValue }}');

        inputFormat$.on('change', function (){
            const dateFormat = $(this).val();
            previewFormat$.flatpickr({
                'dateFormat': dateFormat,
                'defaultDate': new Date(),
                'locale': globeLanguage === 'vi' ? 'vn' : 'default',
            });
        })

        const typeInit$ = frm$.find('#{{ rTypeInitValueIdx }}');
        const inputValueInit$ = frm$.find('#{{ rCustomInitValue }}');
        const groupCustomInit$ = frm$.find('#date-group-custom-init');

        inputValueInit$.flatpickr({
            'allowInput': true,
            'altInput': true,
            'enableTime': true,
            'altFormat': 'l, j-m-Y H:i',
            'dateFormat': 'Y-m-d H:i',
            'defaultDate': inputValueInit$.val() || null,
            'locale': globeLanguage === 'vi' ? 'vn' : 'default',
            'weekNumbers': true,
        })

        typeInit$.on('change', function (){
            switch ($(this).val()) {
                case 'custom':
                    inputValueInit$.attr('required', true);
                    groupCustomInit$.slideDown();
                    break
                case 'unset':
                case 'now':
                default:
                    inputValueInit$.attr('required', false);
                    groupCustomInit$.slideUp();
                    break
            }
        });

        const datetimeMin$ = frm$.find('#{{ rDatetimeMinValueIdx }}');
        const datetimeMax$ = frm$.find('#{{ rDatetimeMaxValueIdx }}');
        datetimeMin$.flatpickr({
            altInput: true,
            altFormat: 'd-m-Y H:i',
            dateFormat: 'Y-m-d H:i:S',
            enableTime: true,
            locale: globeLanguage === 'vi' ? 'vn' : 'default',
        });
        datetimeMax$.flatpickr({
            altInput: true,
            altFormat: 'd-m-Y H:i',
            dateFormat: 'Y-m-d H:i:S',
            enableTime: true,
            locale: globeLanguage === 'vi' ? 'vn' : 'default',
        });

        datetimeMin$.on('change', function (){
            const minPicker = $(datetimeMin$)[0]._flatpickr;
            const maxPicker = $(datetimeMax$)[0]._flatpickr;
            if (minPicker && maxPicker){
                const minValue = minPicker.selectedDates[0];
                const maxValue = maxPicker.selectedDates[0];
                if (minValue && maxValue){
                    if (minValue > maxValue) {
                        maxPicker.clear();
                    }
                }
            }
        })
        datetimeMax$.on('change', function (){
            const minPicker = $(datetimeMin$)[0]._flatpickr;
            const maxPicker = $(datetimeMax$)[0]._flatpickr;
            if (minPicker && maxPicker){
                const minValue = minPicker.selectedDates[0];
                const maxValue = maxPicker.selectedDates[0];
                if (minValue && maxValue){
                    if (minValue > maxValue) {
                        minPicker.clear();
                    }
                }
            }
        })
    })
</script>