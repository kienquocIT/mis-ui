{% load static compress i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'Login' %} &#8901; Bflow</title>
    <meta name="description" content="Bflow"/>

    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'assets/images/brand/bflow/png/icon/icon-bflow-original-36x36.png' %}">
    <link rel="icon" href="{% static 'assets/images/brand/bflow/png/icon/icon-bflow-original-36x36.png' %}" type="image/x-icon">

    <meta property="og:url" content="www.bflow.vn"/>
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="{% trans 'Login' %} &#8901; Bflow"/>
    <meta property="og:description" content="Bflow - Giải pháp toàn diện cho doanh nghiệp"/>
    <meta property="og:image" content="{% static 'assets/images/brand/bflow/png/icon/icon-bflow-original-36x36.png' %}"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    {% compress css %}
        <!-- CSS -->
        <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'assets/css/loading-spinner.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'assets/css/notify.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'login/auth.css' %}" rel="stylesheet" type="text/css">
        <style>
            html, body {
                font-family: "Josefin Sans", sans-serif;
                  font-optical-sizing: auto;
                  font-style: normal;
            }

            select option:checked {
                background-color: #e5fdff !important;
                color: #37ceda !important;
            }
        </style>
        <style>
            #canvas {
                background-image: url("{% static 'login/bg_login_10.jpg' %}");
                background-repeat: no-repeat;
                background-position: center;
                background-size: cover;
                {#filter: blur(5px);#}
            }
        </style>
    {% endcompress %}
</head>
<body>
<!-- Wrapper -->
<div class="hk-wrapper hk-pg-auth bg-light position-relative" data-footer="simple">
    <!-- Main Content -->
    <div class="hk-pg-wrapper pt-0 pb-xl-0 pb-5">
        <canvas id="canvas" class="position-absolute"></canvas>
        <div class="hk-pg-body pt-0 pb-xl-0">
            <!-- Container -->
            <div class="container-xxl">
                <!-- Row -->
                <div class="row mx-auto" style="max-width: 500px; max-height: 700px;">
                    <div class="col-12 position-relative ">
                        <form
                                class="w-100"
                                id="form-login"
                                data-url="{% url 'AuthLogin' %}" data-url-redirect="" data-method="POST"
                                autocomplete="off"
                                data-url-select-tenant="{% url 'AuthLoginSelectTenant' %}"
                                data-url-2fa="{% url 'TwoFAVerifyView' %}"
                        >
                            <div class="card card-border bg-light">
                                <div class="card-body">
                                    <div class="text-center my-5 overflow-hidden">
                                        <a class="navbar-brand me-0" href="https://www.bflow.vn">
                                            <img class="brand-img d-inline-block"
                                                 src="{% static 'assets/images/brand/bflow-by-mts/png/bflow-by-mts-original.png' %}"
                                                 alt="brand"
                                                 style="width: 50%; object-fit: cover;"
                                            >
                                        </a>
                                    </div>
    {#                                    <div class="w-100 mb-4">#}
    {#                                        <h4 class="text-center">{% trans 'Login' %}</h4>#}
    {#                                    </div>#}
                                    <div class="row gx-3">
                                        <div class="form-group">
                                            <div class="form-label-group d-none">
                                                <label class="form-label" for="inp-tenant-code">Tenant</label>
                                            </div>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fa-solid fa-globe"></i>    </span>
                                                <label for="inp-username"></label>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    name="tenant_code"
                                                    id="inp-tenant-code"
                                                    placeholder="{% trans 'Tenant' %}"
                                                    tabindex="1"
                                                    required
                                                />
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fa fa-user"></i></span>
                                                <label for="inp-username"></label>
                                                <input
                                                        type="text"
                                                        class="form-control"
                                                        name="username"
                                                        id="inp-username"
    {#                                                        placeholder="{% trans 'Username' %}"#}
                                                        placeholder="{% trans 'Username or email' %}"
                                                        tabindex="1"
                                                        required
                                                        autofocus
                                                >
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <div class="input-group position-relative">
                                                <span class="input-group-text">
                                                    <i class="fa fa-lock"></i>
                                                </span>
                                                <span class="position-absolute" style="z-index: 99999; cursor: pointer; right: 12px; top: 8px;" id="btn-show-passwd">
                                                    <i class="fa-solid fa-eye"></i>
                                                    <i class="fa-solid fa-eye-slash d-none"></i>
                                                </span>
                                                <label for="inp-password"></label>
                                                <input type="password" class="form-control" name="password" id="inp-password" placeholder="{% trans 'Password' %}" tabindex="2" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-check form-check-sm mb-3">
                                        <input
                                                name="remember"
                                                type="checkbox" class="form-check-input" id="logged_in"
                                                checked tabindex="3"
                                        >
                                        <label
                                                class="form-check-label text-muted fs-7"
                                                for="logged_in"
                                        >{% trans 'Keep me logged in' %}</label>
                                    </div>
                                    <div id="recapcha" class="mt-1 mb-1"></div>
                                    <button type="submit" class="btn btn-primary btn-uppercase btn-block mb-3" tabindex="4">{% trans 'Login' %}</button>
                                    <div class="d-flex justify-content-between align-items-center mb-0">
                                        <small class="flex-item">
                                            <a href="https://www.bflow.vn/#trial-form">{% trans 'Sign Up' %}</a>
                                        </small>
                                        <small class="flex-item"><a href="{% url 'ForgotPasswordView' %}">{% trans 'Forgot Password ?' %}</a></small>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-12 mt-3 position-relative text-center">
                        <p class="footer-text pb-0 copyrighttext">
                            <span class="copy-text">BFlow © 2023 All rights reserved.</span>
                        </p>
                    </div>
                </div>
                <!-- /Row -->
            </div>
            <!-- /Container -->
        </div>
        <!-- /Page Body -->
    </div>
    <!-- /Main Content -->
    <!-- spinner loading -->
    <div id="loadingContainer" class="loading-container hidden">
        <div class="my-spinner">
            <div class="my-circle my-circle-1"></div>
            <div class="my-circle my-circle-2"></div>
            <div class="my-circle my-circle-3"></div>
            <div class="my-circle my-circle-4"></div>
            <div class="my-circle my-circle-5"></div>
        </div>
    </div>
    <!-- /spinner loading -->
    <div class="hidden">
        <span id="flagNotifyKey" data-value={{ is_notify_key }}></span>
    </div>
</div>
<!-- /Wrapper -->

<script src="{% url 'javascript-catalog' packages='auth' %}"></script>
{% if captcha_enabled == True %}
    <script type="text/javascript">
        window.ggCaptChaEnabled = "True";
        function onloadCallback() {
            grecaptcha.render('recapcha', {
                'sitekey': '{{ secret_key_gg }}'
            });
        }
    </script>
    <script
            src="https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit"
            async defer
    >
    </script>
{% endif %}

{% compress js %}
    <!-- jQuery -->
    <script src="{% static 'vendors/jquery/dist/jquery.min.js' %}"></script>
    <script src="{% static 'vendors/jquery-validate/jquery.validate.min.js' %}"></script>

    <!-- Bootstrap Core JS -->
    <script src="{% static 'vendors/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>

    <!-- FeatherIcons JS -->
    <script src="{% static 'assets/js/feather.min.js' %}"></script>

    <!-- Fancy Dropdown JS -->
    <script src="{% static 'assets/js/dropdown-bootstrap-extended.js' %}"></script>

    <!-- Simplebar JS -->
    <script src="{% static 'vendors/simplebar/dist/simplebar.min.js' %}"></script>

    <!-- Notify Popup -->
    <script src="{% static 'assets/js/notify.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap-notify.min.js' %}"></script>

    <!-- Init JS -->
    <script src="{% static 'assets/js/init.js' %}"></script>
    <script src="{% static 'login/backdrop-animated.js' %}"></script>
    <script src="{% static 'login/login.js' %}"></script>

    <!-- Custom JS -->
    <script>
        function authGettext(txt){
            try {
                return gettext(txt)
            } catch (e) {
                return txt
            }
        }
        $(document).ready(function () {
            let boxHeight = $('.hk-pg-body').height();
            $(':root').css('--box-height', `(50vh + ${boxHeight/2}px)`);

            $('#btn-show-passwd').on('click', function (){
                $(this).children().toggleClass('d-none');
                let inpPasswd = $(this).siblings('input[name="password"]');
                inpPasswd.attr('type') === 'password' ? inpPasswd.attr('type', 'text') : inpPasswd.attr('type', 'password');
            })

            let fixedDomain = '{{ui_fixed_domain}}';
            let mainDomain = '{{ui_domain}}';
            let hostData = window.location.hostname;
            let frmLoginEle = $('#form-login');

            if (fixedDomain) {
                if (fixedDomain.endsWith(hostData)) {
                    const inp$ = $(":input[name=tenant_code]");
                    let tenantCode = fixedDomain.split(".")[0];
                    if (tenantCode) {
                        inp$.val(tenantCode).attr('readonly', 'readonly');
                    } else {
                        inp$.focus();
                    }
                }
            }

            if (!fixedDomain) {
                if (hostData.endsWith(mainDomain)) {
                    const inp$ = $(":input[name=tenant_code]");
                    let tenantCode = hostData.split(mainDomain)[0];
                    if (tenantCode.endsWith(".")) tenantCode = tenantCode.split(".")[0];

                    if (tenantCode) {
                        inp$.val(tenantCode).attr('readonly', 'readonly');
                    } else {
                        inp$.focus();
                    }
                }
            }

            frmLoginEle.submit(function (event) {
                event.preventDefault();

                let state = false;
                if (window.ggCaptChaEnabled === 'True') {
                    let response = grecaptcha.getResponse();
                    if (!response) {
                        $.fn.notifyBLogin({
                            'description': authGettext('Please solve the captcha.'),
                        }, 'failure');
                        return false;
                    } else {
                        state = true;
                    }
                } else {
                    state = true;
                }

                if (state) {
                    $.fn.showLoadingLogin();
                    let frm = new SetupFormSubmitLogin($(this));
                    if (frm.dataUrl && frm.dataMethod) {
                        if (window.ggCaptChaEnabled === 'True' && !frm.dataForm['g-recaptcha-response']) {
                            $.fn.notifyBLogin({
                                'description': authGettext('Please solve the captcha.'),
                            }, 'failure');
                            setTimeout(
                                () => {
                                    $.fn.hideLoadingLogin();
                                }, 2000
                            )
                            return false;
                        }
                        $.fn.callAjaxLogin(
                            frm.dataUrl,
                            frm.dataMethod,
                            {
                                ...frm.dataForm,
                                'g_recaptcha_response': frm.dataForm?.['g-recaptcha-response'] || ''
                            }
                        ).then(
                            (resp) => {
                                let data = resp.data;
                                if (data.status === 200) {
                                    localStorage.setItem('tenant_code', frm.dataForm['tenant_code']);
                                    $.fn.notifyBLogin({description: data.detail}, 'success');
                                    let path_redirect = data?.['redirect_to'] || "/";
                                    if (path_redirect === '2fa'){
                                        path_redirect = frmLoginEle.attr('data-url-2fa');
                                    }
                                    const params = Object.fromEntries(new URLSearchParams(location.search));
                                    if (path_redirect){
                                        path_redirect += '?' + $.param({'next': params.next});
                                    } else if (params.next) {
                                        path_redirect = params.next;
                                    }
                                    $.fn.redirectUrlLogin(
                                        path_redirect, 800
                                    );
                                }
                                setTimeout(
                                    () => {
                                        $.fn.hideLoadingLogin();
                                    }, 2000
                                )
                            },
                            (err) => {
                                const data = err?.['data'] || {};
                                if (Object.keys(data).length > 0){
                                    Object.entries(data).map(
                                        ([key, value]) => {
                                            if (key !== 'status') {
                                                $.fn.notifyBLogin({
                                                    'description': value,
                                                }, 'failure');
                                            }
                                        }
                                    )
                                } else {
                                    $.fn.notifyBLogin({
                                        'description': authGettext('The username or password is incorrect'),
                                    }, 'failure')
                                }
                                $.fn.hideLoadingLogin();
                            }
                        )
                    } else throw 'Setup call raise exception with URL or method is incorrect.!';
                }
            })
        });
    </script>
    <script>
        async function unregisterServiceWorkers() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }
            }
        }
        unregisterServiceWorkers();
        localStorage.removeItem('fcmClean');  // flag clean of FCM
    </script>
{% endcompress %}
</body>
</html>