{% extends 'base.html' %}
{% load i18n static %}

{% block cssHeader %}
    <style>
        #btn-collapse {
            display: none;
        }

        @media screen and (min-width: 767px) {
            #btn-collapse {
                display: block;
            }

            #idx-box-control {
                padding-right: 1rem;
                border-right: 1px solid #f1f1f1;
            }

            #idx-box-data {
                padding-left: 1rem;
            }
        }
    </style>
{% endblock %}

{% block pageContent %}
    {{ data|json_script:"idx-template-link" }}
    <div class="row">
        <div class="col-lg-3 col-md-4 col-xs-12" id="idx-box-control">
            <div class="w-100 mb-5">
                <div class="form-group">
                    <label for="inp-application" class="form-label required">{% trans 'Application' %}</label>
                    <select
                            id="inp-application" class="form-select"
                            data-url="{% url 'TenantApplicationListAPI' %}?allow_import=true"
                            data-method="GET" data-keyResp="tenant_application_list"
                            required
                    ></select>
                </div>
                <a
                        href="#"
                        id="idx-link-template"
                        style="display: none;"
                        data-static-url="{% static '' %}"
                >{% trans 'Click here to download template file' %}.</a>
            </div>
            <div class="w-100 mb-5">
                <div class="form-group">
                    <label for="formFile" class="form-label required">{% trans 'Choose the Excel file to import data' %}</label>
                    <input class="form-control" type="file" id="formFile" disabled required>
                    <small class="text-muted form-text" id="file-remarks"></small>
                </div>
            </div>
            <div class="w-100 mb-3">
                <button class="btn btn-outline-primary w-100 mb-1" disabled>{% trans 'Verify' %}</button>
                <button class="btn btn-soft-primary w-100 mb-1" disabled>{% trans 'Save' %}</button>
            </div>
        </div>
        <div class="col-lg-9 col-md-8 col-xs-12" id="idx-box-data">
            <button
                    class="btn btn-xs btn-icon btn-soft-secondary mb-2"
                    id="btn-collapse"
            >
                <span class="icon"><i class="fa-solid fa-angles-left"></i></span>
            </button>
            <div class="w-100">
                <p class="title">{% trans 'Display Import Data' %}</p>
                <table class="table w-100 no-wrap" id="tbl-display-data"></table>
            </div>
        </div>
    </div>
{% endblock %}

{% block jsHeaderUnCompress %}
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
{% endblock %}

{% block jsFooter %}
    <script>
        $(document).ready(function () {
            let boxData$ = $('#idx-box-data');
            let boxControl$ = $("#idx-box-control");
            let linkTemplateList$ = $('#idx-link-template');
            let inpFile$ = $('#formFile');
            let inpApp$ = $('#inp-application');

            let templateData = JSON.parse($('#idx-template-link').text());
            let templateSelectedData = {};

            function renderData(data) {
                let columnsConfig = templateSelectedData?.['columns'] || [];
                if (!(data && Array.isArray(data) && data.length > 1)) return false;

                const tbl$ = $('#tbl-display-data');

                if ($.fn.DataTable.isDataTable('#tbl-display-data')) tbl$.DataTable().destroy();

                let headData = data[0];

                let bodyDatas = data.slice(1);

                function parseToDataAndColumns() {
                    let columns = headData.map(
                        (item, idx) => {
                            return {
                                data: idx,
                                render: (data, type, row) => {
                                    return data;
                                }
                            }
                        }
                    )
                    columns.push({
                        width: '10%',
                        render: (data, type, row) => {
                            return `
                                <span class="badge badge-soft-primary"><i class="fa-solid fa-check"></i></span>
                                <span class="badge badge-soft-danger"><i class="fa-solid fa-xmark"></i></span>
                            `;
                        }
                    })
                    let data = bodyDatas.map(
                        (item, index) => {
                            let tmp = {};
                            for (let i = 0; i < item.length; i++) {
                                tmp[i] = item[i];
                            }
                            tmp['idx'] = index + 1;
                            return tmp;
                        }
                    )

                    return {
                        data: data,
                        columns: columns,
                    }
                }

                function destroyOld() {
                    tbl$.empty();
                }

                function renderTHead() {
                    let thead$ = $(`<thead></thread>`);
                    let tr$ = $(`<tr></tr>`);
                    headData.map(
                        (item, idx) => {
                            if (Array.isArray(columnsConfig) && columnsConfig.length > 0 && idx < columnsConfig.length){
                                tr$.append(`
                                    <th>
                                        <p>${item}</p>
                                        <small>${columnsConfig[idx].remarks}</small>
                                    </th>
                                `);
                            } else tr$.append(`<th><p>${item}</p><small></small></th>`);
                        }
                    )
                    tr$.append(`<th><p><i class="fa-solid fa-tractor"></i></p><small></small></th>`);
                    thead$.append(tr$);
                    tbl$.append(thead$);
                }

                function renderTBody() {
                    let tbody$ = $(`<tbody></tbody>`);
                    tbl$.append(tbody$);

                    tbl$.DataTable({
                        searching: false,
                        sorting: false,
                        ordering: false,
                        autoWidth: false,
                        ...parseToDataAndColumns(),
                        initComplete: function (){
                            $x.fn.hideLoadingPage();
                        },
                    })
                }

                destroyOld();
                renderTHead();
                renderTBody();
            }

            function readerBufferFile(f){
            let reader = new FileReader();
            reader.onload = function (e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, {type: 'array'});

                // Get first worksheet
                let worksheetName = workbook.SheetNames[0];
                let worksheet = workbook.Sheets[worksheetName];

                // Convert to JSON
                jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                renderData(jsonData);
            };
            reader.readAsArrayBuffer(f);
        }

            inpApp$.initSelect2().on('change', function (){
                let idx = $(this).val();
                templateSelectedData = templateData[idx];
                if (templateSelectedData && templateSelectedData?.['template_link']){
                    linkTemplateList$.attr('href', linkTemplateList$.attr('data-static-url') + templateSelectedData['template_link']).show();
                } else {
                    linkTemplateList$.attr('href', '#').hide();
                }
                inpFile$.prop('disabled', false);
            });
            inpFile$.on('change', function (event) {
                $x.fn.showLoadingPage();

                let files = event.target.files;
                let f = files[0];
                let sizeToMB = f.size / (1024 * 1024);

                if (sizeToMB > 10){
                    $.fn.notifyB({
                        'description': $.fn.gettext('File size must be less than or equal to __size__').replaceAll('__size__', '5MB')
                    }, 'failure');
                    this.value = "";
                    $x.fn.hideLoadingPage();
                    return;
                }
                $('#file-remarks').text(`Size: ${sizeToMB.toFixed(2)}MB`);

                setTimeout(() => readerBufferFile(f), 100);
            });

            let previousState = '1';  // 0: hide, 1: show
            $('#btn-collapse').on('click', function () {
                let i$ = $(this).find('i');
                if (i$.length > 0) {
                    let currentRotate = i$.attr('data-rotate');

                    i$.css('transition-duration', '0.5s');
                    i$.css('transition-property', 'transform');

                    boxControl$.animate(
                        {
                            width: "toggle",
                            opacity: "toggle"
                        },
                        {
                            'duration': 400,
                            'start': function (){
                                boxControl$.children().fadeOut('fast');
                                if (!boxData$.attr('data-old-class')) boxData$.attr('data-old-class', boxData$.getClass('^col-*').join(" "));
                                if (!boxControl$.attr('data-old-class')) boxControl$.attr('data-old-class', boxControl$.getClass('^col-*').join(" "));

                                // show
                                if (previousState === '0') boxData$.alterClass('col-*').addClass(boxData$.attr('data-old-class'));
                            },
                            'done': function () {
                                boxControl$.children().fadeIn('fast');
                                if (!boxData$.attr('data-old-class')) boxData$.attr('data-old-class', boxData$.getClass('^col-*').join(" "));
                                if (!boxControl$.attr('data-old-class')) boxControl$.attr('data-old-class', boxControl$.getClass('^col-*').join(" "));

                                // hide
                                if (previousState === '1') boxData$.alterClass('col-*').addClass('col-12');

                                if (previousState === '0') previousState = '1';
                                else previousState = '0';
                            }
                        }
                    )

                    if (currentRotate) {
                        i$.removeAttr('data-rotate');
                        i$.css({'transform': 'unset'});
                    } else {
                        i$.attr('data-rotate', '1');
                        i$.css({'transform': 'rotate(' + 180 + 'deg)'});
                    }
                }
            })
        })
    </script>
{% endblock %}