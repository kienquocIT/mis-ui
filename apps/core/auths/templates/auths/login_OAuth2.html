{% load static compress i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans 'Login' %} &#8901; Minh Tâm Solution</title>
    <meta name="description" content="Minh Tâm Solution"/>

    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'assets/images/bflow/icon/icon_36x36.png' %}">
    <link rel="icon" href="{% static 'assets/images/bflow/icon/icon_36x36.png' %}" type="image/x-icon">

    {% compress css %}
        <!-- CSS -->
        <link href="{% static 'assets/css/style.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'assets/css/loading-spinner.css' %}" rel="stylesheet" type="text/css">
        <link href="{% static 'assets/css/notify.css' %}" rel="stylesheet" type="text/css">
        <style>
            select option:checked {
                background-color: #e5fdff !important;
                color: #37ceda !important;
            }

            .account-item:hover {
                background-color: slategrey !important;
                color: white;
                cursor: pointer;
            }
        </style>
    {% endcompress %}
</head>
<body>
<!-- Wrapper -->
<div class="hk-wrapper hk-pg-auth" data-footer="simple">
    <!-- Main Content -->
    <div class="hk-pg-wrapper pt-0 pb-xl-0 pb-5">
        <div class="hk-pg-body pt-0 pb-xl-0">
            <!-- Container -->
            <div class="container-xxl">
                <class class="row">
                    {% csrf_token %}
                    <div class="hidden">
                        {{ user_data|json_script:"idxUserData" }}
                    </div>
                    <div class="col-10 col-lg-6 mx-auto overflow-hidden" id="account-group"></div>
                    <span class="btn btn-collapse-login">
                        <i class="fa-solid fa-caret-right"></i> Login another account
                    </span>
                </class>
                <!-- Row -->
                <div class="row hidden" id="idxGroupLoginForm">
                    <div class="col-sm-10 position-relative mx-auto">
                        <div class="auth-content">
                            <form
                                    class="w-100" id="form-login" data-url="{% url 'AuthLogin' %}"
                                    data-url-redirect="" data-method="POST"
                            >
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-lg-5 col-md-7 col-sm-10 mx-auto">
                                        <div class="text-center mb-7">
                                            <a class="navbar-brand me-0" href="/">
                                                <img
                                                        class="brand-img d-inline-block"
                                                        src="{% static 'assets/images/bflow/logo_180x180.png' %}"
                                                        alt="brand"
                                                >
                                            </a>
                                        </div>
                                        <div class="card card-lg card-border">
                                            <div class="card-body">
                                                <h4 class="mb-4 text-center">{% trans 'Sign in to your account' %}</h4>
                                                <div class="row gx-3">
                                                    <div class="form-group col-lg-12">
                                                        <div class="form-label-group">
                                                            <label>Tenant</label>
                                                        </div>
                                                        <select
                                                                class="form-select" id="tenant-select" required
                                                                data-url="{% url 'TenantLoginChoice' %}"
                                                                data-method="GET"
                                                                name="tenant_code"
                                                        >
                                                            <option disabled value="">
                                                                {% trans 'Choose...' %}
                                                            </option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group col-lg-12">
                                                        <div class="form-label-group">
                                                            <label>{% trans 'User Name' %}</label>
                                                        </div>
                                                        <input
                                                                name="username"
                                                                class="form-control"
                                                                placeholder="Enter username or email ID" value=""
                                                                type="text"
                                                                tabindex="1"
                                                                required
                                                        >
                                                    </div>
                                                    <div class="form-group col-lg-12">
                                                        <div class="form-label-group">
                                                            <label>{% trans 'Password' %}</label>
                                                            <a
                                                                    href="#"
                                                                    class="fs-7 fw-medium"
                                                            >{% trans 'Forgot Password ?' %}</a>
                                                        </div>
                                                        <div class="input-group password-check">
																<span class="input-affix-wrapper">
																	<input
                                                                            name="password"
                                                                            class="form-control"
                                                                            placeholder="Enter your password" value=""
                                                                            type="password"
                                                                            tabindex="2"
                                                                            required
                                                                    >
																	<a href="#" class="input-suffix text-muted">
																		<span class="feather-icon"><i
                                                                                class="form-icon"
                                                                                data-feather="eye"
                                                                        ></i></span>
																		<span class="feather-icon d-none"><i
                                                                                class="form-icon"
                                                                                data-feather="eye-off"
                                                                        ></i></span>
																	</a>
																</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-center">
                                                    <div class="form-check form-check-sm mb-3">
                                                        <input
                                                                name="remember"
                                                                type="checkbox" class="form-check-input"
                                                                id="logged_in"
                                                                checked tabindex="3"
                                                        >
                                                        <label
                                                                class="form-check-label text-muted fs-7"
                                                                for="logged_in"
                                                        >{% trans 'Keep me logged in' %}</label>
                                                    </div>
                                                </div>
                                                <input
                                                        type="submit"
                                                        class="btn btn-primary btn-uppercase btn-block"
                                                        value="{% trans 'Login' %}" tabindex="4"
                                                >
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- /Row -->
            </div>
            <!-- /Container -->
        </div>
        <!-- /Page Body -->
    </div>
    <!-- /Main Content -->
    <!-- spinner loading -->
    <div id="loadingContainer" class="loading-container hidden">
        <div class="my-spinner">
            <div class="my-circle my-circle-1"></div>
            <div class="my-circle my-circle-2"></div>
            <div class="my-circle my-circle-3"></div>
            <div class="my-circle my-circle-4"></div>
            <div class="my-circle my-circle-5"></div>
        </div>
    </div>
    <!-- /spinner loading -->
    <div class="hidden">
        <span id="flagNotifyKey" data-value={{ is_notify_key }}></span>
        <span id="errLoginIncorrect" data-value="{% trans 'The username or password is incorrect' %}"></span>
    </div>
</div>
<!-- /Wrapper -->

{% compress js %}
    <!-- jQuery -->
    <script src="{% static 'vendors/jquery/dist/jquery.min.js' %}"></script>

    <!-- Bootstrap Core JS -->
    <script src="{% static 'vendors/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>

    <!-- FeatherIcons JS -->
    <script src="{% static 'assets/js/feather.min.js' %}"></script>

    <!-- Fancy Dropdown JS -->
    <script src="{% static 'assets/js/dropdown-bootstrap-extended.js' %}"></script>

    <!-- Simplebar JS -->
    <script src="{% static 'vendors/simplebar/dist/simplebar.min.js' %}"></script>

    <!-- Notify Popup -->
    <script src="{% static 'assets/js/notify.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap-notify.min.js' %}"></script>


    <!-- Init JS -->
    <script src="{% static 'assets/js/init.js' %}"></script>
    <script>
        // support for Form Submit
        class SetupFormSubmitLogin {
            constructor(formSelected, urlDefault = null, urlRedirectDefault = null, dataMethodDefault = null) {
                this.formSelected = formSelected;

                // URL call API
                this.dataUrl = formSelected.attr('data-url');
                if (!this.dataUrl) this.dataUrl = urlDefault ? urlDefault : window.location.pathname;

                // METHOD call API
                this.dataMethod = formSelected.attr('data-method');
                if (!this.dataMethod) {
                    if (dataMethodDefault) {
                        this.dataMethod = dataMethodDefault
                    } else {
                        throw ('Data Method do not support! It is ' + this.dataMethod);
                    }
                }

                // URL REDIRECT after success callback
                this.dataUrlRedirect = formSelected.attr('data-url-redirect');
                if (!this.dataUrlRedirect) this.dataUrlRedirect = urlRedirectDefault ? urlRedirectDefault : null;

                // REDIRECT TIMEOUT
                this.dataRedirectTimeout = formSelected.attr('data-redirect-timeout');
                if (!this.dataRedirectTimeout) this.dataRedirectTimeout = this.dataRedirectTimeout ? this.dataRedirectTimeout : 1000;

                // Data body get from form input
                this.dataForm = $.fn.serializerObjectLogin(formSelected);

                // URL DETAIL
                this.dataUrlDetail = formSelected.attr('data-url-detail');
                if (!this.dataUrlRedirect) this.dataUrlRedirect = urlRedirectDefault ? urlRedirectDefault : null;
                if (this.dataUrlDetail) {
                    this.dataUrlDetail = this.dataUrlDetail.split("/").slice(0, -1).join("/") + "/";
                }
            }

            getUrlDetail(pk) {
                if (this.dataUrlDetail && pk) {
                    return this.dataUrlDetail + pk.toString();
                }
                return null;
            }

            static getUrlDetailWithID(url, pk) {
                url = url.split("/").slice(0, -1).join("/") + "/";
                if (url && pk) {
                    return url + pk.toString();
                }
                return null;
            }
        }

        String.prototype.format_by_idx = function () {
            // argument of function start 0+ for fill to this
            // `<a href="{0}">{1}</a>`.format("http://...", "Tag a")
            // Return ==> `<a href="http://...">Tag A</a>`
            let s = this.toString();
            return s.replace(/\{(\d)\}/gm, (match, index) => arguments[index]);
        }

        $.fn.extend({
            redirectUrlLogin: function (redirectPath, timeout = 0, params = '') {
                setTimeout(() => {
                    if (params && (params !== '' && params !== undefined)) {
                        window.location.href = redirectPath + '?' + params;
                    } else {
                        window.location.href = redirectPath;
                    }
                }, timeout);
            },
            notifyBLogin: function (option, typeAlert = null) {
                setTimeout(function () {
                    $('.alert.alert-dismissible .close').addClass('btn-close').removeClass('close');
                }, 100);
                let msg = "";
                if (option.title) {
                    msg += option.title;
                }
                if (option.description) {
                    let des_tmp = '';
                    if (typeof option.description === 'string') {
                        des_tmp = option.description;
                    } else if (Array.isArray(option.description)) {
                        des_tmp = option.description.join(", ");
                    } else if (typeof option.description === 'object') {
                        let des_tmp_arr = [];
                        for (const [_key, value] of Object.entries(option.description)) {
                            des_tmp_arr.push(value);
                        }
                        des_tmp = des_tmp_arr.join(", ");
                    } else {
                        des_tmp = option.description.toString();
                    }
                    if (msg) {
                        msg += ": " + des_tmp;
                    } else {
                        msg = des_tmp;
                    }
                }
                let alert_config = {
                    animate: {
                        enter: 'animated bounceInDown',
                        exit: 'animated bounceOutUp'
                    },
                    type: "dismissible alert-primary",
                    z_index: 2147483647, /* Maximum index */
                }
                switch (typeAlert) {
                    case 'success':
                        alert_config['type'] = "dismissible alert-success";
                        break
                    case 'failure':
                        alert_config['type'] = "dismissible alert-danger";
                        break
                    case 'warning':
                        alert_config['type'] = "dismissible alert-warning";
                        break
                    case 'info':
                        alert_config['type'] = "dismissible alert-info";
                        break
                }
                $.notify(msg, alert_config);
            },
            serializerObjectLogin: function (formSelected) {
                return formSelected.serializeArray().reduce((o, kv) => ({
                    ...o,
                    [kv.name]: kv.value
                }), {});
            },
            showLoadingLogin: function (timeout) {
                $('#loadingContainer').removeClass('hidden');
                if (timeout) {
                    setTimeout($.fn.hideLoadingLogin, (timeout > 100 ? timeout : 1000));
                }
            },
            hideLoadingLogin: function () {
                setTimeout(() => {
                    $('#loadingContainer').addClass('hidden');
                }, 250,)
            },
            callAjaxLogin: function (url, method, data = {}, csrfToken = null, headers = {}, content_type = "application/json") {
                return new Promise(function (resolve, reject) {
                    // Setup then Call Ajax
                    let ctx = {
                        url: url,
                        type: method,
                        dataType: 'json',
                        contentType: content_type,
                        data: content_type === "application/json" ? JSON.stringify(data) : data,
                        headers: {
                            "X-CSRFToken": (csrfToken === true ? $("input[name=csrfmiddlewaretoken]").val() : csrfToken), ...headers
                        },
                        success: function (rest, textStatus, jqXHR) {
                            resolve(rest);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            reject(jqXHR.responseJSON);
                        },
                    };
                    if (method.toLowerCase() === 'get') ctx.data = data
                    $.ajax(ctx);
                });
            },
            shortName: function (name, defaultReturn = '', length = 2) {
                if (name) {
                    let rs = name.split(" ").map((item) => {
                        return item ? item.charAt(0) : ""
                    }).join("");
                    if (rs.length > length) return rs[0] + rs[rs.length - 1];
                    return rs;
                }
                return defaultReturn;
            },
        })
    </script>

    <!-- Custom JS -->
    <script>
        const params = Object.fromEntries(new URLSearchParams(location.search));
        let path_redirect = params?.['redirectCallback'];
        let access_id = params?.['id'];
        let accountGroup = $('#account-group');

        function toggleVisibleLogiForm() {
            $('.btn-collapse-login').find('.fa-solid').toggleClass('fa-caret-right').toggleClass('fa-caret-down');
            $('#idxGroupLoginForm').toggleClass('hidden')
        }

        function generateUserLogged(user_data) {
            let companies_data = user_data['companies_data'];
            if (companies_data && Array.isArray(companies_data) && companies_data.length > 0) {
                accountGroup.append(`<div class="bg-light rounded mb-2 py-3 px-2">
                    <div class="row">
                        <div class="col-6 mb-1 d-flex align-items-center justify-content-center">
                            <div class="avatar avatar-primary avatar-rounded align-self-center">
                                ${ user_data['avatar'] ? `<img src="${user_data['avatar']}" alt="user" class="avatar-img">`: `<span class="initial-wrap">${$.fn.shortName(user_data['last_name'] + ' ' + user_data['first_name'])}</span>`}
                            </div>
                        </div>
                        <div class="col-6 mb-1 d-flex align-items-center justify-content-center">
                            <span class="badge badge-success wrap-text align-self-center text-wrap">${user_data['last_name']} ${user_data['first_name']}</span>
                        </div>
                    </div>
                </div>`);
                companies_data.map(
                    (item) => {
                        accountGroup.append(`
                            <div class="account-item rounded bg-light py-3 px-2 mb-2 text-center text-wrap" data-company-id="${item.id}">${item['title']}</div>
                        `);
                    }
                )

            }

        }

        function redirectCallBack(path_redirect) {
            if (path_redirect) {
                let params = {
                    param1: 'value1',
                    param2: 'value2',
                };
                let queryString = Object.keys(params).map(key => key + '=' + encodeURIComponent(params[key])).join('&');
                window.location.href = path_redirect + '?' + queryString;
            }
        }

        $(document).ready(function () {
            let userData = JSON.parse($('#idxUserData').text());
            if (userData) {
                generateUserLogged(userData);
            } else {
                toggleVisibleLogiForm();
            }

            $('.btn-collapse-login').click(function () {
                toggleVisibleLogiForm();
            })

            $(document).on('click', '.account-item', function () {
                $.fn.callAjaxLogin(
                    window.location.href,
                    'POST',
                    {
                        'company_id': $(this).attr('data-company-id'),
                        'access_id': access_id,
                    },
                    true,
                ).then(
                    (resp) => {
                        let data = resp.data;
                        if (data && data.hasOwnProperty('id') && data.hasOwnProperty('access_code') && data.hasOwnProperty('secret_token_regis')) {
                            window.location.href = path_redirect + `?id=${data['id']}&access_code=${data['access_code']}&token=${data['secret_token_regis']}`
                        }
                    },
                )
            });

            $('#form-login').submit(function (event) {
                event.preventDefault();
                $.fn.showLoadingLogin();
                let frm = new SetupFormSubmitLogin($(this));
                if (frm.dataUrl && frm.dataMethod) {
                    $.fn.callAjaxLogin(
                        frm.dataUrl + '?is_oauth2=true',
                        frm.dataMethod,
                        frm.dataForm,
                        $(this).find("input[name=csrfmiddlewaretoken]").val(),
                    ).then(
                        (resp) => {
                            let data = resp.data;
                            if (data.status === 200) {
                                window.location.reload();
                                {#generateUserLogged(data['user_data']);#}
                                {#toggleVisibleLogiForm();#}
                            }
                            setTimeout(
                                () => {
                                    $.fn.hideLoadingLogin();
                                }, 2000
                            )
                        },
                        (err) => {
                            $.fn.notifyBLogin({
                                'description': $('#errLoginIncorrect').attr('data-value')
                            }, 'failure')
                            $.fn.hideLoadingLogin();
                        }
                    )
                } else throw 'Setup call raise exception with URL or method is incorrect.!';
            });

            //
            function loadTenantList() {
                let tenant_element = $('#tenant-select');
                if (tenant_element.attr('data-loaded') !== true) {
                    $.fn.callAjaxLogin(tenant_element.attr('data-url'), tenant_element.attr('data-method')).then(
                        (resp) => {
                            let beforeTenantCode = localStorage.getItem('tenant_code');
                            let code_list = [];
                            tenant_element.attr('data-loaded', true);
                            tenant_element.children().remove();
                            resp.result.map((element) => {
                                if (beforeTenantCode && element.code === beforeTenantCode) {
                                    tenant_element.append(`<option value="` + element.code + `" selected="selected">` + String.format('{0} - {1}', element.code, element.title) + `</option>`);
                                } else {
                                    tenant_element.append(`<option value="` + element.code + `">` + String.format('{0} - {1}', element.code, element.title) + `</option>`);
                                }
                                code_list.push(element.code);
                            });

                            let tenant_code = window.location.hostname.split(".");
                            if (tenant_code) {
                                let code_selected = tenant_code[0].toUpperCase();
                                if (code_list.indexOf(code_selected) !== -1) {
                                    tenant_element.find('option[value=' + code_selected + ']').attr('selected', 'selected');
                                }
                            }
                            {#tenant_element.children().last().attr('selected', 'selected');#}
                        },
                        (err) => {
                            tenant_element.attr('data-loaded', false);
                        }
                    )
                }
            }

            loadTenantList();
        });
    </script>
{% endcompress %}
</body>
</html>