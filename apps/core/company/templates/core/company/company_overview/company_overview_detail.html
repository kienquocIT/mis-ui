{% extends 'base.html' %}
{% load static i18n %}

{% block cssHeader %}
    <link href="{% static 'vendors/select2/dist/css/select2.min.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block pageContent %}
    <div class="mb-3">
        <div class="inline">
            <label for="company_overviewing" class="hidden"></label>
            <select class="custom-select" id="company_overviewing">
                {% for item in data.company_list %}
                    <option value="{{ item.id }}">{{ item.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="inline">
            <label for="filter_data_employee_user" class="hidden"></label>
            <select class="custom-select" id="filter_data_employee_user">
                <option value="filter_all_user_and_employee">{% trans 'All user and employee' %}</option>
                <option value="filter_employee_linked_to_user">{% trans 'Employee Linked To User' %}</option>
            </select>
        </div>
        <br class="clearBoth"/>
    </div>
    {{ data.company_list|json_script:"company_all_list" }}
    <table
            id="datable_company_overview_detail" class="table nowrap w-100 mb-5"
            data-url-detail="{% url "EmployeeUserByCompanyListOverviewDetailAPI" pk=1 %}"
            data-method="GET"
    >
        <thead>
        <tr>
            <th>Data Row</th>
            <th>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input">
                </div>
            </th>
            <th>{% trans 'Employee' %}</th>
            <th>{% trans 'License' %}</th>
            <th>{% trans 'User' %}</th>
            <th>{% trans 'Company Allow Login' %}</th>
            <th>{% trans 'Actions' %}</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div
            class="modal fade" id="power_user_info" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenter"
            aria-hidden="true"
    >
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form
                        id="modal_employee_update" data-url="{% url 'EmployeeDetailAPI' %}" data-method="PUT" method="post"
                        novalidate
                >
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="power_user_title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <label for="company_list_old">{% trans 'Company Selected' %}:</label>
                        <ol id="company_list_old" data-text-empty="{% trans 'No records' %}"></ol>
                        <label for="company_list_choose">{% trans 'Company Change' %}:</label>
                        <select
                                class="select2 select2-multiple" multiple="multiple" data-placeholder="Choose"
                                id="company_list_choose"
                        >
                            {% for item in data.company_list %}
                                <option value="{{ item.id }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="update_employee">{% trans 'Save' %}</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            {% trans 'Cancel' %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}


{% block jsFooter %}
    <script src="{% static 'vendors/select2/dist/js/select2.full.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            // selected company select box
            let company_overviewing_id = window.location.href.split("?")[0].split("#")[0].split("/").slice(-1)[0];
            if (company_overviewing_id) {
                $('#company_overviewing').find('option[value=' + company_overviewing_id + ']').attr('selected', 'selected')
            }


            // convert data company
            let company_all_list = JSON.parse($('#company_all_list').html());
            let company_by_id = company_all_list.convert_to_key();

            // init table data
            let tbl = $('#datable_company_overview_detail');
            tbl.DataTable({
                searching: false,
                ordering: false,
                paginate: false,
                drawCallback: function () {
                    {#render icon after table callback#}
                    feather.replace();
                },
                columns: [
                    {
                        visible: false,
                        searchable: false,
                        render: (data, type, row, meta) => {
                            return String.format(
                                `<script type="application/json">{0}<\/script>`,
                                JSON.stringify(row)
                            )
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            return `<div class="form-check"><input type="checkbox" class="form-check-input"></div>`
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            return `<a href="#"><span class="badge badge-primary">{0}</span> {1}</a>`.format_by_idx(row.code, row.full_name);
                        }
                    },
                    {
                        data: 'license',
                        className: 'wrap-text',
                        render: (data, type, row, meta) => {
                            let html = '';
                            if (data)
                                data.map((item) => {
                                    html += `<span class="{3}" data-id="{0}" data-code="{1}">{2}</span>`.format_by_idx(
                                        item.id,
                                        item.code,
                                        item.title,
                                        "badge badge-indigo mr-1"
                                    )
                                });
                            return html;
                        }
                    },
                    {
                        data: 'user',
                        render: (data, type, row, meta) => {

                            let html = `<div class="media align-items-center"><div class="media-head me-2">{0}</div><div class="media-body">{1}</div></div>`;
                            return html.format_by_idx(
                                `<div class="avatar avatar-xs avatar-primary avatar-rounded"><span class="initial-wrap">{0}</span></div>`.format_by_idx(
                                    data.full_name ? data.full_name.split(" ").slice(-1)[0].charAt(0) : ''
                                ),
                                `<span class="d-block">{0}</span> `.format_by_idx(
                                    `<a href="#">{0}</a>`.format_by_idx(
                                        data.full_name ? data.full_name : ''
                                    )
                                )
                            )
                        }
                    },
                    {
                        data: 'company_id_list',
                        className: 'wrap-text',
                        render: (data, type, row, meta) => {
                            let html = '';
                            let title = '';
                            if (data && Array.isArray(data)) {
                                for (let item of data)
                                    for (let value of company_all_list)
                                        if (value.id === item.id) {
                                            title = value.title
                                            break;
                                        }
                                html += `<span class="badge badge-soft-primary mr-1">${title}</span> `;
                            }
                            return html;
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            return `<div><a class="{0}" data-bs-toggle="tooltip" data-bs-placement="top" title="" data-bs-original-title="Edit" href="#" data-id="{1}">{2}</a></div>`.format_by_idx(
                                "btn btn-icon btn-flush-dark btn-rounded flush-soft-hover edit-button",
                                row.id,
                                `<span class="{0}" data-bs-toggle="modal" data-bs-target="#power_user_info">{1}</span></span>`.format_by_idx(
                                    "btn-icon-wrap btn-open-power-user-info",
                                    `<span class="feather-icon"><i data-feather="edit"></i>`
                                ),
                            )
                        }
                    }
                ]
            });

            // multiple select company popup info
            $('#company_list_choose').select2();

            // event click open popup info
            $(document).on('click', '.btn-open-power-user-info', function (event) {
                event.preventDefault();
                let data = get_data_row($(this), tbl);

                load_power_user_to_modal(
                    data.user ? data.user.full_name : data.full_name,
                    "c46f4cec-6201-4132-84cb-a1201eef8316",
                    data.company_id_list && Array.isArray(data.company_id_list) ? data.company_id_list : [],
                    company_by_id ? company_by_id : null,
                )
            });

            // filter_all_user_and_employee
            let data_all_user_and_employee = [];
            let data_employee_linked_user = [];
            $(document).on('change', '#filter_data_employee_user', async function (event) {
                switch (this.value) {
                    case 'filter_all_user_and_employee':
                        if (data_all_user_and_employee.length === 0) {
                            data_all_user_and_employee = await get_data(company_overviewing_id, {});
                        }
                    {#delete before commit#}
                        data_all_user_and_employee[0]['company_id_list'] = [
                            {
                                "id": "4acfa2c7-2720-4b29-8b7e-dcd471bfa16b",
                                "title": "Công ty Cổ Phần Giải Pháp Minh Tâm",
                            },
                        ]
                        data_all_user_and_employee[0]['user'] = {"full_name": data_all_user_and_employee[0]['full_name']}
                        data_all_user_and_employee[0]['license'] = [
                            {"id": 2, "code": "e-office", "title": "E-Office"}
                        ]
                        tbl.DataTable().clear().rows.add(data_all_user_and_employee).draw();
                        break;
                    case 'filter_employee_linked_to_user':
                        if (data_all_user_and_employee.length === 0) {
                            data_employee_linked_user = await get_data(company_overviewing_id, {});
                        }
                        tbl.DataTable().clear().rows.add(data_employee_linked_user).draw();
                        break;
                }
            });
            $('#filter_data_employee_user').trigger('change');  // call change for load data
        });

        function get_data_row(row, tabl) {
            let currentRow = $(row).closest("tr");
            return tabl.DataTable().row(currentRow).data();
        }

        function load_power_user_to_modal(user_full_name, company_id_default, company_id_list, company_data_obj) {
            // change title by user.full_name
            $('#power_user_title').html(
                String.format(
                    `<div class="media align-items-center"><div class="media-head me-2">{0}</div><div class="media-body">{1}</div></div>`,
                    String.format(
                        `<div class="avatar avatar-xs avatar-primary avatar-rounded"><span class="initial-wrap">{0}</span></div>`,
                        user_full_name ? user_full_name.charAt(0) : ''
                    ),
                    String.format(
                        `<span class="d-block">{0}</span> `,
                        user_full_name ? user_full_name : ''
                    )
                )
            );

            // show old company
            let ul_company_old = $('#company_list_old');
            ul_company_old.html("");
            if (Array.isArray(company_id_list) && company_id_list.length > 0) {
                company_id_list.map((id) => {
                    ul_company_old.append(
                        `<li>{0} {1}</li>`.format_by_idx(
                            id.title,
                            (company_id_default && company_id_default === id ? `<span class="required"><span>` : "")
                        )
                    )
                })
            } else {
                ul_company_old.append(`<p>{0}</p>`.format_by_idx(
                    ul_company_old.attr('data-text-empty')
                ))
            }


            // select company
            let mul_selected = $('#company_list_choose');
            mul_selected.val(null).trigger('change');
            for (let item of company_id_list){
                mul_selected.val(item.id);
            }
            mul_selected.select2();

            // handle event click update user
            updateEmployee()
        }

        async function get_data(pk, filter) {
            let frm = new SetupFormSubmit($('#datable_company_overview_detail'));
            return $.fn.callAjax(
                frm.appendFilter(frm.getUrlDetail(pk), filter),
                frm.dataMethod
            ).then(
                (resp) => {
                    let data = $.fn.switcherResp(resp);
                    if (data && data.hasOwnProperty('data_list')) {
                        return data.data_list;
                    }
                },
                (errs) => {
                    return []
                },
            )
        }

        function updateEmployee(){
            $('#modal_employee_update').on('submit', function(e){
                alert('you submited')
                $(this).modal('hide');
            })
        }
    </script>
{% endblock %}
