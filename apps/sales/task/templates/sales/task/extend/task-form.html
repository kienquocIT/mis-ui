{% load i18n %}
<style>
    .is-lazy-loading .span_loading{display: none;}
    .is-lazy-loading.is_show .span_loading{display: block;position: absolute;z-index: 2;left: 50%;top: 50%;transform: translate(-50%, -50%);}
    .is-lazy-loading.is_show:after {content: "";position: absolute;width: 100%;height: 100%;background: rgba(255, 255, 255,.8);z-index: 1;top: 0;}
    .label-mark {width: 100%;height: 38px;color: #262a2e;border: 1px solid #d8d8d8;border-radius: 0.375rem;padding: 0.375rem 0.75rem;font-size: 1rem;line-height: 1.5;}
    .label-mark:hover {border-color: #007D88;}
    .label-mark.dropdown-toggle:after {content: '';right: 0;}
    .label-mark .item-tag {color: #ffffff;background: var(--bs-info);border-radius: 0.375rem;padding: 1px 4px 2px;font-size: .8rem;}
    .label-mark .item-tag > .tag-delete {margin-left: 4px;color: #555555;cursor: pointer;}
    .label-mark .item-tag + .item-tag {margin-left: 4px;}

    @media screen and (min-width:1280px){
        .offcanvas-xl{
            width: 768px!important;
        }
    }
    .task_loading{display: none}
</style>
<!--Offcanvas Wrapper-->
<div class="offcanvas offcanvas-end w-40" tabindex="-1" id="offCanvasRightTask" aria-hidden="true" data-bs-focus="false">
	<div class="offcanvas-header">
		<h5 id="offcanvasRightLabel">
            <div>
                <span class="title-create">{% trans 'Create Task' %}</span>
                <span class="title-detail hidden">{% trans 'Detail Task' %}</span>
            </div>
        </h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div class="offcanvas-body">
        <form class="container-fluid mt-4" data-url="{% url 'OpportunityTaskListAPI' %}" id="formOpportunityTask"
              method="post" autocomplete="off" data-method="POST">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-12 col-xs-12 parents-block hidden">
                    <div class="form-group">
                        <label for="inputTextTitle" class="form-label">{% trans 'Task parent' %}</label>
                        <div class="input-affix-wrapper">
                            <input type="text" class="form-control" name="parent" readonly/>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 col-xs-12">
                    <div class="form-group">
                        <label for="inputTextTitle" class="form-label required">{% trans 'Name' %}</label>
                        <div class="input-affix-wrapper">
                            <input type="text" class="form-control" name="title" id="inputTextTitle" required/>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="inputTextCode" class="form-label">{% trans 'Code' %}</label>
                        <input type="text" class="form-control" name="code" id="inputTextCode" disabled/>
                    </div>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="selectStatus" class="form-label">{% trans 'Select Status' %}</label>
                        <select class="form-select" name="task_status" id="selectStatus"
                                data-keyResp="task_status"
                                data-url="{% url 'OpportunityTaskStatusAPI' %}"
                        ></select>
                    </div>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="inputTextStartDate" class="form-label">{% trans 'Start date' %}</label>
                        <div class="input-affix-wrapper">
                            <input type="text" class="form-control date-picker" name="start_date"
                                   id="inputTextStartDate"/>
                            <span class="input-suffix"><i class="fa-solid fa-calendar-days"></i></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="inputTextEndDate" class="form-label">{% trans 'End date' %}</label>
                        <div class="input-affix-wrapper">
                            <input type="text" class="form-control date-picker" name="end_date" id="inputTextEndDate"/>
                            <span class="input-suffix"><i class="fa-solid fa-calendar-days"></i></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="inputTextEstimate" class="form-label required">{% trans 'Estimate' %}</label>
                        <input type="text" class="form-control" name="estimate" id="inputTextEstimate"
                               placeholder="eg. 4d 12h" required/>
                        <p class="form-text text-muted text-blue">
                            {% trans 'An estimate of how much time you have spent working.' %}</p>
                    </div>
                    <input type="text" class="hidden" name="log_time">
                    <a href="#" class="text-bold d-inline-block btn-log_work text-decoration-underline mb-3">
                        {% trans 'Log time' %}
                    </a>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="selectPriority" class="form-label">{% trans 'Priority' %}</label>
                        <select class="form-select" name="priority" id="selectPriority">
                            <option value="0">{% trans 'Low' %}</option>
                            <option value="1">{% trans 'Medium' %}</option>
                            <option value="2">{% trans 'High' %}</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-12 col-xs-12">
                    <div class="slider w-100 mb-2">
                        <label for="percent_completed" class="form-label">{% trans 'Percent completed' %}</label>
                        <div class="d-block">
                            <p id="rangeValue" class="d-inline-block">0</p><small>%</small>
                        </div>
                        <input class="w-100" type="range" min="0" max="100" value="0" step="5"
                               oninput="rangeValue.innerText=this.value" id="percent_completed"
                               name="percent_completed">
                    </div>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="form-group">
                        <label for="inputAssigner" class="form-label">{% trans 'Assigner' %}</label>
                        <input class="form-control" name="employee_created" id="inputAssigner"
                               data-name="{{ request.user.employee_current_data.last_name }}. {{ request.user.employee_current_data.first_name }}"
                               data-value-id="{{ request.user.employee_current_data.id }}"
                               readonly>
                    </div>
                </div>
                {% if data.create_group_allow %}
                    <div class="col-md-6 col-xs-12" id="has_group_assignee">
                        <br class="mt-2">
                        <p><a href="#" class="text-decoration-underline text-uppercase" data-bs-toggle="modal" data-bs-target="#modalAssigneeGroup">{% trans 'Create' %}</a> {% trans 'employee group for receiving tasks' %}</p>
                    </div>
                {% endif %}
                <div class="col-xs-12 custom-layout">
                    {% trans 'Assignee' as inherit_title %}
                    {% if is_project_page %}
                        {% trans 'Project code' as prj_title %}
                        {% include 'extends/the-documents/bastion.html' with show_warning=True priority_app='prj-inherit-opp-process' has_prj=True prj_disabled=True has_inherit=True is_open=True new_list_from_app=new_list_from_app %}
                    {% elif not_bastion != True %}
                        {% trans 'Opp code' as opp_title %}
                        {% trans 'Project code' as prj_title %}
                        {% include 'extends/the-documents/bastion.html' with auto_select_current_employee=False show_warning=True priority_app='opp-process-prj-inherit' has_opp=True has_process=True has_prj=has_prj has_inherit=True is_open=True inherit_required=False new_list_from_app=new_list_from_app new_list_from_app_id=data.list_from_app_id %}
                    {% elif not_bastion and custom_assignee %}
                        <div class="row">
                            <div class="col-12 col-md-6 col-lg-6">
                                <div class="form-group">
                                    <label for="custom_assignee" class="form-label required">{% trans 'Assignee' %}</label>
                                    <select
                                            name="employee_inherit_id"
                                            id="custom_assignee"
                                            class="form-select"
                                            data-url="{% url 'EmployeeListAPI' %}"
                                            data-method="GET"
                                            data-keyResp="employee_list"
                                            data-keyText="full_name"
                                            data-params="{'is_active': 'true'}"
                                    ></select>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-12 col-xs-12">
                    <div class="form-group">
                        <label for="inputLabel" class="form-label">{% trans 'Label' %}</label>
                        <input class="form-control hidden" name="label" id="inputLabel">
                        <div class="w-100 btn-group dropdown">
                            <div class="label-mark" aria-haspopup="true" data-bs-display="static">
                            </div>
                            <div class="dropdown-menu form-tags-input-wrap dropdown-menu-lg-end"
                                 data-bs-popper="static">
                                <div class="d-flex justify-content-start align-items-center flex-gap-3">
                                    <input type="text" class="form-control" id="inputLabelName">
                                    <button type="button" class="btn btn-soft-success btn-add-tag">
                                        <i class="fa-solid fa-check"></i>
                                    </button>
                                    <button type="button" class="btn btn-soft-danger btn-close-tag">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 col-xs-12">
                    <div class="form-group">
                        <label for="textareaRemark" class="form-label">{% trans 'Description' %}</label>
                        <textarea class="form-control ck5-rich-txt" name="remark" id="textareaRemark"></textarea>
                    </div>
                </div>
                <div class="col-xs-12 mt-2">
                    <ul class="nav nav-light nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#tab_checklist">
                                <span class="nav-link-text">{% trans 'Checklist' %}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tab_subtask">
                                <span class="nav-link-text">{% trans 'Sub task' %}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tab_attach">
                                <span class="nav-link-text">{% trans 'Files' %}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#tab_logwork">
                                <span class="nav-link-text">{% trans 'Log time history' %}</span>
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab_checklist">
                            <div class="wrap-checklist mb-4"></div>
                            <div class="hidden check-item-template">
                                <div class="d-flex justify-content-start align-items-center checklist_item">
                                    <div class="form-check form-check-sm">
                                        <input type="checkbox" class="form-check-input">
                                        <label class="form-check-label"
                                               contenteditable="true">{% trans 'checklist' %}</label>
                                    </div>
                                    <button class="btn btn-flush-primary btn-icon btn-rounded ml-auto flush-soft-hover">
                                            <span>
                                                <i class="fa-regular fa-trash-can fa-sm"></i>
                                            </span>
                                    </button>
                                </div>
                            </div>
                            <button type="button"
                                    class="btn btn-flush-primary flush-soft-hover create-checklist"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    data-bs-original-title="{% trans 'Add' %}">
                                    <span class="btn-icon-wrap d-flex justify-content-start align-items-center flex-gap-3">
                                        <i class="fa-solid fa-plus"></i>
                                        <span>{% trans 'Add' %}</span>
                                    </span>
                            </button>
                        </div>
                        <div class="tab-pane fade" id="tab_subtask">
                            <div class="wrap-subtask mb-4"></div>
                            <button type="button"
                                    class="btn btn-flush-primary flush-soft-hover create-subtask hidden"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    data-bs-original-title="{% trans 'Add' %}"
                            >
                                    <span class="btn-icon-wrap d-flex justify-content-start
                                    align-items-center flex-gap-3">
                                        <i class="fa-solid fa-plus"></i>
                                        <span>{% trans 'Add' %}</span>
                                    </span>
                            </button>
                        </div>
                        <div class="tab-pane fade" id="tab_attach">
                            <div class="row">
                                <div class="col-xs-12 col-lg-6 col-md-6">
                                    <label for="#" class="mb-2">{% trans 'Files of Assigner' %}</label>
                                    <div id="assigner_attachment">
                                        {% include 'extends/files/all.html' %}
                                    </div>
                                </div>
                                <div class="col-xs-12 col-lg-6 col-md-6">
                                    <label for="#" class="mb-2">{% trans 'Files of Assignee' %}</label>
                                    <div id="assignee_attachment">
                                        {% include 'extends/files/all.html' %}
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="tab-pane fade" id="tab_logwork">
                            <div class="overflow-x-scroll">
                                <table class="table nowrap w-100 mb-5" id="table_log-work">
                                    <thead>
                                    <tr>
                                        <th>{% trans 'Employee' %}</th>
                                        <th>{% trans 'Start date' %} ~ {% trans 'End date' %}</th>
                                        <th>{% trans 'Time spent' %}</th>
                                        <th></th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
            <div class="d-flex justify-content-start align-items-center mt-3">
                <button type="submit" form="formOpportunityTask" class="btn btn-primary create-task">
                    <p class="txt-create">
                        {% trans 'Save' %}
                    </p>
                    <p class="txt-update">
                        {% trans 'Update' %}
                    </p>
                </button>
                <button type="button" class="btn btn-danger cancel-task ml-auto" data-bs-dismiss="offcanvas">{% trans 'Cancel' %}
                </button>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-soft-primary"
                        id="btn-open-comment-task">{% trans 'Comments' %}</button>
            </div>
        </form>
        <div class="task_loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
	</div>
</div>
<!--/ Offcanvas Wrapper-->

{% block dataHiddenGroup %}
    {{ data.employee_info|json_script:"employee_info" }}
    <input type="hidden" id="form_valid"
           data-valid-datetime="{% trans 'End time was large than Start time' %}"
           data-logtime-valid="{% trans 'Missing info to log time' %}"
           data-assign-txt="{% trans 'Assign to me' %}"
           data-estimate-error="{% trans 'Estimate is wrong format' %}"
    >
    <input type="hidden" id="task_url_sub"
           data-task-config="{% url 'OpportunityTaskConfigAPI' %}"
           data-opps-detail="{% url 'OpportunityDetailAPI' 0 %}"
           data-employee="{% url 'EmployeeListAPI' %}">
{% endblock %}
{% block modalData %}
    <div class="modal fade" id="modalAssigneeGroup" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalCenter" aria-hidden="true" data-url="{% url 'TaskAssigneeGroupListAPI' %}">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Create" %} {% trans "employee group for receiving tasks" %}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="group_data_onload" aria-label="hidden modal data load">
                    <div class="col">
                        <div class="form-group mb-2">
                            <label class="label-field form-label required" for="group_title">{% trans "Title" %}</label>
                            <input class="form-control" type="text" id="group_title"
                                   placeholder="group received new project">
                        </div>
                        <div class="form-group">
                            <label class="label-field form-label required" for="group_assignee_list">{% trans "Employee list" %}</label>
                            <select id="group_assignee_list" class="form-select" name="group_assignee_list"
                                    multiple
                                    data-closeOnSelect="false"
                                    data-allowClear="true"
                                    data-url="{% url 'EmployeeListAPI' %}"
                                    data-keyResp="employee_list" data-keyText="full_name" data-keyId="id"
                                    data-params="{'is_active': 'true'}"
                            ></select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="save_group">
                        {% trans 'Save' %}
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
<div class="modal fade" id="logWorkModal" tabindex="-1" role="dialog"
     aria-labelledby="logWorkModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans 'Log time' %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <span>Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="startDateLogTime" class="form-label required">{% trans 'Start Date' %}</label>
                    <div class="input-affix-wrapper">
                        <input type="text" class="form-control date-picker" name="start_date_logtime"
                               id="startDateLogTime"/>
                        <span class="input-suffix"><i class="fa-solid fa-calendar-days"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="endDateLogTime" class="form-label required">{% trans 'End Date' %}</label>
                    <div class="input-affix-wrapper">
                        <input type="text" class="form-control date-picker" name="start_date_logtime"
                               id="endDateLogTime"/>
                        <span class="input-suffix"><i class="fa-solid fa-calendar-days"></i></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="EstLogtime" class="form-label required">{% trans 'Estimate' %}</label>
                    <input type="text" class="form-control" name="estimate_logtime" id="EstLogtime"
                           placeholder="eg. 4d 12h"/>
                    <p class="form-text text-muted text-blue">
                        {% trans 'An estimate of how much time you have spent working.' %}</p>
                </div>
                <input type="hidden" id="logtime_task_id">
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-primary" id="save-logtime">{% trans 'Save' %}</button>
                <button type="button" class="btn btn-secondary ml-auto"
                        data-bs-dismiss="modal">{% trans 'Close' %}</button>
            </div>
        </div>
    </div>
</div>