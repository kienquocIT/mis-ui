{% extends 'base.html' %}
{% load i18n static %}

{% block pageAction %}
    <button
            class="btn btn-outline-primary"
            type="button"
            id="btn-download-file"
            data-id="{{ pk }}"
    >
        <span>
            <span class="no-transform">{% trans 'Download' %}</span>
            <span class="icon">
                <i class="fa-solid fa-download"></i>
            </span>
        </span>
    </button>
    <button
            class="btn btn-outline-primary"
            type="button"
            data-bs-toggle="modal"
            data-bs-target="#fileInfoModal"
    >
        <span>
            <span class="no-transform">{% trans 'Information' %}</span>
            <span class="icon">
                <i class="fa-solid fa-circle-info"></i>
            </span>
        </span>
    </button>
{% endblock %}

{% block pageContent %}
{% endblock %}

{% block modalData %}
    <div
            class="modal fade"
            id="fileInfoModal"
            tabindex="-1" role="dialog" aria-labelledby="fileInfoModal" aria-hidden="true"
            data-keyboard="false" data-backdrop="static"
            data-bs-keyboard="false" data-bs-backdrop="static"
            data-url="{% url 'AttachmentInfo' pk=pk %}"
    >
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans 'File properties' %}</h5>
                    <button
                            type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                    >
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block jsHeaderUnCompress %}
    <script src="{% static 'vendors/xlsx/dist/xlsx.full.min.js' %}"></script>
    <script src="{% static 'vendors/jszip/dist/jszip.min.js' %}"></script>
    <script src="{% static 'vendors/docx-preview/dist/docx-preview.min.js' %}"></script>
{% endblock %}

{% block jsFooter %}
    <script>
        const employeeDetailUrl = "{% url 'EmployeeDetail' pk='__pk__' %}";
        const gatewayDocDetail = "{% url 'GatewayMiddleDetailView' plan='__plan__' app='__app__' pk='__pk__' %}?redirect=true";

        $(document).ready(function () {
            const pk = "{{pk}}";
            new $x.cls.fileStream({'pk': pk}).distribution();

            $('#btn-download-file').on('click', function (){
                $x.cls.file.download($(this).attr('data-id'));
            })
            const modalInfo$ = $('#fileInfoModal');
            const modalBody$ = modalInfo$.find('.modal-body')
            modalInfo$.on('shown.bs.modal', function (){
                const url = $(this).attr('data-url');
                const state = $(this).attr('data-loaded');
                if (state !== 'true') {
                    $(this).attr('data-loaded', 'true');
                    $.fn.callAjax2({
                        url: url,
                        method: 'GET',
                        isLoading: true
                    }).then(
                        resp => {
                            const data = $.fn.switcherResp(resp);
                            console.log('data:', data);
                            if (data && data.hasOwnProperty('file_info')){
                                const fileInfo = data['file_info'] || {};
                                const thead$ = $('<thead></thead>');
                                thead$.append(`
                                    <tr>
                                        <th class="no-transform">${$.fn.gettext('Properties')}</th>
                                        <th class="no-transform">${$.fn.gettext('Values')}</th>
                                    </tr>
                                `)

                                const tbody$ = $('<tbody></tbody>');

                                const fName = fileInfo?.['file_name'] || '';
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('File title')}</td>
                                        <td>${fName}</td>
                                    </tr>
                                `);

                                const remarks = fileInfo?.['remarks'] || '';
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('Remarks')}</td>
                                        <td>${remarks}</td>
                                    </tr>
                                `);

                                const contentType = fileInfo?.['file_type'] || null;
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('File type')}</td>
                                        <td>${$x.cls.fileStream.getAppByContentType(contentType)}</td>
                                    </tr>
                                `);

                                const fSize = fileInfo?.['file_size'] || null;
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('File size')}</td>
                                        <td>${$x.cls.file.parse_size(fSize)}</td>
                                    </tr>
                                `);

                                const relateApp = fileInfo?.['relate_app'] || null;
                                const relateAppTitle = relateApp ? relateApp?.['title'] || '' : '';
                                const relateAppPlan = relateApp ? relateApp?.['plan'] || '' : '';
                                const relateAppApp = relateApp ? relateApp?.['app'] || '' : '';
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('Application related')}</td>
                                        <td>${relateAppTitle ? `<span class="badge badge-soft-primary">${$.fn.gettext(relateAppTitle)}</span>` : ''}</td>
                                    </tr>
                                `);

                                const relateDoc = fileInfo?.['relate_doc'] || null;
                                let linkToDetail = '';
                                if (relateDoc && relateAppPlan && relateAppApp) {
                                    const linkTmp = gatewayDocDetail
                                        .replaceAll('__plan__', relateAppPlan)
                                        .replaceAll('__app__', relateAppApp)
                                        .replaceAll('__pk__', relateDoc)
                                    linkToDetail = `<a href="${linkTmp}">${relateDoc}</a>`
                                }
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('Document related')}</td>
                                        <td>
                                           ${linkToDetail ? linkToDetail : relateDoc ? relateDoc : ''}
                                        </td>
                                    </tr>
                                `);

                                const folder = fileInfo?.['folder'] || null;
                                const folderTitle = folder ? folder?.['title'] || '' : '';
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('Folder')}</td>
                                        <td>${folderTitle ? `<span class="badge badge-soft-primary">${folderTitle}</span>` : ''}</td>
                                    </tr>
                                `);

                                const employeeCreated = fileInfo?.['employee_created'] || null;
                                tbody$.append(`
                                    <tr>
                                        <td>${$.fn.gettext('Employee created')}</td>
                                        <td><a href="${employeeDetailUrl.replaceAll('__pk__', employeeCreated['id'])}">${employeeCreated ? employeeCreated['full_name'] : '-'}</a></td>
                                    </tr>
                                `);

                                const tableTmp$ = $('<table class="w-100 table table-bordered"></table>').append(thead$).append(tbody$);
                                modalBody$.empty().append(tableTmp$);
                            }
                        },
                        errs => $.fn.switcherResp(errs),
                    )
                }
            })
        })
    </script>
{% endblock %}