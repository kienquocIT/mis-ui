{% extends 'base.html' %}
{% load static i18n %}

{% block cssHeader %}
    <link href="{% static 'vendors/select2/dist/css/select2.min.css' %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block pageContent %}
    <div class="mb-3">
        <div class="inline">
            <label for="company_overviewing" class="hidden"></label>
            <select class="custom-select" id="company_overviewing">
                {% for item in data.company_list %}
                    <option value="{{ item.id }}">{{ item.title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="inline">
            <label for="filter_data_employee_user" class="hidden"></label>
            <select class="custom-select" id="filter_data_employee_user">
                <option value="filter_all_user_and_employee">{% trans 'All user and employee' %}</option>
                <option value="filter_employee_linked_to_user">{% trans 'Employee Linked To User' %}</option>
            </select>
        </div>
        <br class="clearBoth"/>
    </div>
    {{ data.company_list|json_script:"company_all_list" }}
    <table
            id="datable_company_overview_detail" class="table nowrap w-100 mb-5"
            data-url-detail="{% url "EmployeeUserByCompanyListOverviewDetailAPI" pk=data.pk %}"
            data-method="GET"
    >
        <thead>
        <tr>
            <th>Data Row</th>
            <th>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input">
                </div>
            </th>
            <th>{% trans 'Employee' %}</th>
            <th>{% trans 'License' %}</th>
            <th>{% trans 'User' %}</th>
            <th>{% trans 'Company Allow Login' %}</th>
            <th>{% trans 'Actions' %}</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div
            class="modal fade" id="power_user_info" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenter"
            aria-hidden="true"
    >
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form
                        id="modal_user_update" data-url="{{ data.user_url }}" data-method="put" method="post"
                        novalidate
                >
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="power_user_title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="user_id">
                        <label for="company_list_old">{% trans 'Company Selected' %}:</label>
                        <ol id="company_list_old" data-text-empty="{% trans 'No records' %}"></ol>
                        <label for="company_list_choose">{% trans 'Company Change' %}:</label>
                        <select
                                class="select2 select2-multiple" multiple="multiple" data-placeholder="Choose"
                                id="company_list_choose" name="company_list"
                        >
                            {% for item in data.company_list %}
                                <option value="{{ item.id }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary btn-submit">{% trans 'Save' %}</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            {% trans 'Cancel' %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}


{% block jsFooter %}
    <script src="{% static 'vendors/select2/dist/js/select2.full.min.js' %}"></script>
    <script>
        $(document).ready(function () {
            // selected company select box
            let company_overviewing_id = window.location.href.split("?")[0].split("#")[0].split("/").slice(-1)[0];
            if (company_overviewing_id) {
                $('#company_overviewing').find('option[value=' + company_overviewing_id + ']').attr('selected', 'selected')
            }


            // convert data company
            let company_all_list = JSON.parse($('#company_all_list').html());
            let company_by_id = company_all_list.convert_to_key();

            // init table data
            let tbl = $('#datable_company_overview_detail');
            tbl.DataTable({
                searching: false,
                ordering: false,
                paginate: false,
                drawCallback: function () {
                    {#render icon after table callback#}
                    feather.replace();
                },
                columns: [
                    {
                        visible: false,
                        searchable: false,
                        render: (data, type, row, meta) => {
                            return String.format(
                                `<script type="application/json">{0}<\/script>`,
                                JSON.stringify(row)
                            )
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            return `<div class="form-check"><input type="checkbox" class="form-check-input"></div>`
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            let html = "";
                            if (row['employee']) {
                                let employee = row.employee
                                if (employee && Object.keys(employee).length !== 0)
                                    html = `<a href="javascript:void(0)"><span class="badge badge-primary">{0}</span> {1}</a>`.format_by_idx(
                                        employee.code, employee.full_name);
                            }
                            return html
                        }
                    },
                    {
                        data: 'employee',
                        className: 'wrap-text',
                        render: (data, type, row, meta) => {
                            let html = '';
                            if (data && Object.keys(data).length !== 0) {
                                let licence = data.license_list;
                                for (let item of licence) {
                                    let txt_class_list = {
                                        'e-office': 'primary',
                                        'hrm': 'success',
                                        'personal': 'info',
                                        'sale': 'danger'
                                    };
                                    html += `<span class="{3}" data-id="{0}" data-code="{1}">{2}</span>`.format_by_idx(
                                        item.id,
                                        item.code,
                                        item.title,
                                        `badge badge-soft-${txt_class_list[item.code]} mr-1 mb-1`
                                    )
                                }
                            }
                            return html;
                        }
                    },
                    {
                        data: 'user',
                        render: (data, type, row, meta) => {

                            let html = `<div class="media align-items-center"><div class="media-head me-2">{0}</div><div class="media-body">{1}</div></div>`;
                            return html.format_by_idx(
                                `<div class="avatar avatar-xs avatar-primary avatar-rounded"><span class="initial-wrap">{0}</span></div>`.format_by_idx(
                                    data.full_name ? data.full_name.split(" ").slice(-1)[0].charAt(0) : ''
                                ),
                                `<span class="d-block">{0}</span> `.format_by_idx(
                                    `<a href="#">{0}</a>`.format_by_idx(
                                        data.full_name ? data.full_name : ''
                                    )
                                )
                            )
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            let html = '';
                            if (Object.keys(row.user).length !== 0) {
                                let company_list = row.user.company_list
                                for (let item of company_list)
                                    html += `<span class="badge badge-soft-primary mr-1">${item.title}</span> `;
                            }
                            return html;
                        }
                    },
                    {
                        render: (data, type, row, meta) => {
                            return `<div><a class="{0}" data-bs-toggle="tooltip" data-bs-placement="top" title="" data-bs-original-title="Edit" href="#" data-id="{1}">{2}</a></div>`.format_by_idx(
                                "btn btn-icon btn-flush-dark btn-rounded flush-soft-hover edit-button",
                                row.id,
                                `<span class="{0}" data-bs-toggle="modal" data-bs-target="#power_user_info">{1}</span></span>`.format_by_idx(
                                    "btn-icon-wrap btn-open-power-user-info",
                                    `<span class="feather-icon"><i data-feather="edit"></i>`
                                ),
                            )
                        }
                    }
                ]
            });

            // multiple select company popup info
            $('#company_list_choose').select2();

            // event click open popup info
            $(document).on('click', '.btn-open-power-user-info', function (event) {
                event.preventDefault();
                let data = get_data_row($(this), tbl);
                load_power_user_to_modal(data, $(this), tbl)
            });

            // filter_all_user_and_employee
            let data_filter = [];
            $(document).on('change', '#filter_data_employee_user', async function (event) {
                let temp = await get_data(company_overviewing_id, {filter: this.value});
                if (temp && temp['company_data'])
                    data_filter = temp['company_data']
                tbl.DataTable().clear().rows.add(data_filter).draw();
            });
            $('#filter_data_employee_user').trigger('change');  // call change for load data
        });

        function get_data_row(row, tabl) {
            let currentRow = $(row).closest("tr");
            return tabl.DataTable().row(currentRow).data();
        }

        function load_power_user_to_modal(data_row, current_focus, tb) {
            // change title by user.full_name
            let user_full_name = '';
            if (data_row && Object.keys(data_row.user).length !== 0)
                user_full_name = data_row.user.full_name
            $('#power_user_title').html(
                String.format(
                    `<div class="media align-items-center"><div class="media-head me-2">{0}</div><div class="media-body">{1}</div></div>`,
                    String.format(
                        `<div class="avatar avatar-xs avatar-primary avatar-rounded"><span class="initial-wrap">{0}</span></div>`,
                        user_full_name.charAt(0)
                    ),
                    String.format(
                        `<span class="d-block">{0}</span> `,
                        user_full_name
                    )
                )
            );

            // show old company and select company
            let mul_selected = $('#company_list_choose');
            mul_selected.val(null).trigger('change');
            let ul_company_old = $('#company_list_old');
            ul_company_old.html("");

            if (data_row.user.company_list && Array.isArray(data_row.user.company_list) && data_row.user.company_list.length > 0) {
                let temp = '';
                for (let item of data_row.user.company_list) {
                    temp += `<li>${item.title} ${item.is_created_company ? '<span class="required"><span>' : ''}</li>`

                    {#trigger item attribute for company list#}
                    if (item.is_created_company) {
                        mul_selected.find('option[value="' + item.id + '"]').prop('disabled', true)
                        mul_selected.append('<input type="hidden" name="companies_default" data-name="' + item.title + '" value="' + item.id + '">');
                    } else mul_selected.find('option[value="' + item.id + '"]').prop('selected', true)
                }
                ul_company_old.append(temp)
            } else {
                ul_company_old.append(`<p>${ul_company_old.attr('data-text-empty')}</p>`)
            }

            // select company
            mul_selected.trigger('change');

            if (data_row.user && Object.keys(data_row.user).length !== 0)
                $('[name="user_id"]').val(JSON.stringify(data_row.user.id));
            // handle event click update user
            updateEmployee(current_focus, tb)
        }

        async function get_data(pk, filter) {
            let frm = new SetupFormSubmit($('#datable_company_overview_detail'));
            return $.fn.callAjax(
                frm.appendFilter(frm.getUrlDetail(pk), filter),
                frm.dataMethod
            ).then(
                (resp) => {
                    let data = $.fn.switcherResp(resp);
                    if (data && data.hasOwnProperty('data_list')) {
                        return data.data_list;
                    }
                },
                (errs) => {
                    return []
                },
            )
        }

        function updateEmployee(current_focus, tb) {
            $('#modal_user_update .btn-submit').on('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const $form = document.getElementById('modal_user_update');
                const _form = new FormData($form);
                let form_url = $($form).attr('data-url');
                form_url = `${form_url}/${_form.get('user_id').replaceAll('"', '')}`;
                let default_company = {
                    title: $('[name="companies_default"]').attr('data-name'),
                    id: $('[name="companies_default"]').val(),
                    is_created_company: true,
                }
                let req = $.fn.callAjax(
                    form_url,
                    $($form).attr('data-method'),
                    {'companies': _form.getAll('company_list').concat($('[name="companies_default"]').val())},
                    _form.get('csrfmiddlewaretoken')
                )

                req.then(function (res) {
                    let data = $.fn.switcherResp(res);
                    if (data && data.status === 200) {
                        $.fn.notifyPopup({description: data.detail}, 'success')

                        {#after save#}
                        let data_table_row = tb.DataTable().row(current_focus.closest("tr")).data();
                        let company_change = $('[name="company_list"]').select2('data')
                        data_table_row['user']['company_list'] = []
                        if (company_change.length)
                            for (let item of company_change) {
                                data_table_row['user']['company_list'].push({
                                    'id': item.id,
                                    'title': item.text,
                                    'is_created_company': false
                                })
                            }
                        data_table_row['user']['company_list'].push(default_company)
                        tb.DataTable().row(current_focus.closest("tr")).data(data_table_row).draw();

                    } else $.fn.notifyPopup({description: data.detail}, 'error')
                })
                $(this).parents('.modal').modal('hide');
            })
        }
    </script>
{% endblock %}
