{% extends 'base.html' %}
{% load static i18n %}

{% block cssHeader %}
    <style>
        .dataTables_processing span {
            color: red !important;
        }
    </style>
    <style>
        #popover-user {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(124, 124, 124, 0.4);
            z-index: 1054;
        }

        #popover-user .popover-detail {
            width: 90%;
            min-width: 300px;
            max-width: 500px;
            height: 100%;
            background-color: #fff;
            float: right;
            box-shadow: 0 0 3px 1px #9e9e9e;
        }

        .popover-detail .popover-head {
            height: 40px;
            line-height: 40px;
            padding-left: 10px;
            background-color: #f2f5f6;
            border-bottom: 1px solid #dce2e5;
            color: #5e7d8a;
            font-weight: bold;
        }

        .popover-detail .popover-body {
            height: calc(100% - 40px - 40px);
            padding: 10px;
            overflow-y: scroll;
        }

        .popover-detail .popover-foot {
            height: 40px;
            background-color: #f2f5f6;
            border-top: 1px solid #dce2e5;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            justify-content: end;
        }

        .popover-detail .popover-foot button {
            width: 100px;
            height: 25px;
            margin-right: 10px;
        }
    </style>
    <link href="{% static 'vendors/select2/dist/css/select2.min.css' %}" rel="stylesheet" type="text/css">
{% endblock %}
{% block pageAction %}{% endblock %}
{% block pageContent %}
    <div class="hidden">
        <span id="notify-employee-mapped-text">{% trans 'Linked with employee' %}</span>
        <span id="notify-employee-not-mapped-text">{% trans "Don't have link with employee" %}</span>
    </div>
    {{ data.company_list|json_script:"id-company-list" }}
    <div class="mb-3">
        <ul class="nav nav-line nav-light nav-tabs">
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#tab_block_overview">
                    <span class="nav-link-text">{% trans 'Overview' %}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#tab_block_tenant">
                    <span class="nav-link-text">{% trans 'User of Tenant' %}</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="tab" href="#tab_block_company">
                    <span class="nav-link-text">{% trans 'Employee of Company' %}</span>
                </a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade" id="tab_block_overview">
                <table
                        id="datable_company_overview_list" class="table nowrap w-100 mb-5"
                        data-url="{% url "CompanyListOverviewListAPI" %}"
                        data-url-redirect="/"
                        data-method="GET"
                        data-url-detail="{% url 'CompanyDetail' pk=1 %}"
                >
                    <thead>
                    <tr>
                        <th></th>
                        <th class="wrap-text">
                            {% trans 'Code' %}
                            <i
                                    class="fas fa-info-circle icon-info"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    title="{% trans 'Press row here to open detail page.' %}"
                            ></i>
                        </th>
                        <th class="wrap-text">{% trans 'Name' %}</th>
                        <th class="wrap-text">{% trans 'License Used' %}</th>
                        <th class="wrap-text">{% trans 'Total User' %}</th>
                        <th class="wrap-text">{% trans 'Power User' %}</th>
                        <th class="wrap-text">{% trans 'Employee Linked User / Total Employee' %}</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot class="bg-primary-light-5">
                    <tr>
                        <th></th>
                        <th class="text-primary"><b>{% trans 'Tenant' %}</b></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                    </tfoot>
                </table>
            </div>
            <div class="tab-pane fade" id="tab_block_tenant">
                <table
                        id="tbl-user-of-tenant"
                        class="table nowrap w-100 mb-5"
                        data-url="{% url "UserTenantOverviewListAPI" %}"
                        data-method="GET"
                        data-url-detail="{% url 'UserDetail' pk=1 %}"
                >
                    <thead>
                    <tr>
                        <th></th>
                        <th>
                            {% trans 'Username' %}
                            <i
                                    class="fas fa-info-circle icon-info"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    title="{% trans 'Press row here to open detail page.' %}"
                            ></i>
                        </th>
                        <th>{% trans 'User' %}</th>
                        <th>
                            {% trans 'Company List' %}
                            <i
                                    class="fas fa-info-circle icon-info"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="bottom"
                                    title="{% trans 'Left: Company Name | Right: Linked with employee' %}"
                            ></i>
                        </th>
                        <th>{% trans 'Action' %}</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="tab_block_company">
                {% include 'core/company/company_overview/employee_of_company.html' %}
            </div>
        </div>
    </div>
    <div
            class="modal fade" id="changeUserCompanies"
            tabindex="-1" role="dialog"
            aria-labelledby="exampleModalCenter"
            aria-hidden="true"
    >
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form
                        id="modalUserUpdate"
                        data-url-detail="{% url 'EmployeeUserByCompanyListOverviewDetailAPI' pk=1 %}"
                        data-method="PUT"
                        novalidate
                        data-msg-no-changes="{% trans 'No changes' %}"
                >
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="userPersonFullname" data-id=""></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div>
                            <span class="badge badge-soft-warning">{% trans 'Do not encourage remove company that has linked with employee' %}</span>
                        </div>
                        <br/>
                        <div>
                            <label for="userCompaniesExist">{% trans 'User companies currently' %}</label>
                            <ul class="list-group" id="userCompaniesExist"></ul>
                        </div>
                        <br/>
                        <div>
                            <label for="company_list_choose">{% trans 'Change companies' %}</label>
                            <select
                                    class="select2 select2-multiple" multiple="multiple" data-placeholder="Choose"
                                    id="company_list_choose" name="company_list"
                            >
                                {% for item in data.company_list %}
                                    <option value="{{ item.id }}">{{ item.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="group-action-footer">
                            <button
                                    type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                            >{% trans 'Close' %}</button>
                            <button type="submit" class="btn btn-primary">{% trans 'Save' %}</button>
                        </div>
                        <div class="spinner-border loading-spinner hidden" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="popover-user" style="display: none;">
        <div class="popover-detail" style="display: none;">
            <div class="popover-head">
                <p class="popover-title">User ABC</p>
            </div>
            <div class="popover-body">
                <p class="h5">{% trans 'User companies currently' %}</p>
                <table class="table table-bordered table-hover table-sm mb-4" id="user-company-detail">
                    <thead class="thead-secondary">
                        <tr>
                            <th>{% trans 'Company name' %}</th>
                            <th>{% trans 'Linked with employee' %}</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p class="h5">{% trans 'Change companies' %}</p>
                <form
                        data-url="{% url 'EmployeeUserByCompanyListOverviewDetailAPI' pk='__pk__' %}"
                        data-id=""
                        data-method="PUT"
                ></form>
            </div>
            <div class="popover-foot">
                <button class="btn btn-secondary btn-square btn-xs no-transform popover-cancel" type="button">
                    {% trans 'Cancel' %}
                </button>
                <button class="btn btn-primary btn-square btn-xs no-transform popover-submit" type="button">
                    {% trans 'Save' %}
                </button>
            </div>
        </div>
    </div>
{% endblock %}
{% block jsFooter %}
    <script src="{% static 'vendors/jquery/dist/jquery-ui.min.js' %}"></script>
    <script src="{% static 'vendors/select2/dist/js/select2.full.min.js' %}"></script>
    <script src="{% static 'core/company/company_overview/js/company_overview_list.js' %}"></script>
    <script>
        $(document).ready(function () {
            const company_list = JSON.parse($('#id-company-list').text());
            const company_dict = company_list.reduce((obj, item) => {
                obj[item.id] = item;
                return obj;
            }, {});

            const popover$ = $('#popover-user');
            const popoverDetail$ = popover$.find('.popover-detail');
            const btnCancel$ = popover$.find('.popover-cancel');
            const btnSubmit$ = popover$.find('.popover-submit');
            const title$ = popover$.find('.popover-title');
            const frm$ = popover$.find('form');
            const table$ = popover$.find('#user-company-detail');
            const tbody$ = table$.find('tbody');

            popover$.on('data.close', function () {
                popoverDetail$.hide('slide', {direction: "right"}, 250, function () {
                    popover$.fadeOut(100)
                })
            });
            popover$.on('data.show', function () {
                popover$.fadeIn(100, function (){
                    popoverDetail$.show('slide', {direction: "right"}, 250)
                })
            });
            popover$.on('data.load', function (event, data) {
                const full_name = data?.['full_name'] || '';
                title$.text(full_name);

                const userID = data?.['id'] || '';
                frm$.attr('data-id', userID);

                const company_list_current = data?.['company_list'] || [];
                const employee_mapped = data?.['employee_mapped'] || {};
                tbody$.empty();
                company_list_current.map(
                    companyID => {
                        const tr$ = $('<tr></tr>');

                        const companyData = company_dict?.[companyID] || {};
                        tr$.append(`<td>${companyData?.['title'] || ''}</td>`);

                        const employeeMapped = employee_mapped?.[companyID] || null;
                        if (employeeMapped){
                            tr$.append(`<td><i class="fas fa-user-check i-blue"></i></td>`);
                        } else {
                            tr$.append(`<td><i class="fas fa-user-times i-red"></i></td>`);
                        }
                        tbody$.append(tr$);
                    }
                )

                frm$.empty();
                Object.entries(company_dict).map(
                    ([companyID, companyData]) => {
                        const idxTmp = 'a_' + $x.fn.randomStr(32);
                        const state = company_list_current.indexOf(companyID) !== -1;
                        frm$.append(`
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="${idxTmp}" data-value="${companyID}" ${state ? "checked": ""}>
                                <label class="form-check-label" for="${idxTmp}">${companyData?.['title'] || ''}</label>
                            </div>
                        `)
                    }
                )
            })
            frm$.on('submit', function (event){
                event.preventDefault();
                let companySelected = [];
                frm$.find('input[type=checkbox]:checked').each(function (){
                    const eID = $(this).attr('data-value');
                    companySelected.push(eID);
                })
                $.fn.callAjax2({
                    url: frm$.attr('data-url').replace('__pk__', frm$.attr('data-id')),
                    method: 'PUT',
                    data: {
                        'companies': companySelected
                    },
                    isLoading: true,
                }).then(
                    resp => {
                        const dataResp = $.fn.switcherResp(resp);
                        if (dataResp){
                            $.fn.notifyB({
                                'description': $.fn.gettext('Success')
                            }, 'success');
                            $('#tbl-user-of-tenant').DataTable().ajax.reload();
                            popover$.trigger('data.close');
                        }
                    },
                    errs => $.fn.switcherResp(errs),
                )
            })
            btnSubmit$.on('click', function () {
                frm$.trigger('submit');
            })
            btnCancel$.on('click', function () {
                popover$.trigger('data.close');
            });

            $('#tbl-user-of-tenant').on('click', 'button.btn-edit-popup', function (event) {
                const rowData = $x.fn.getRowData($(event.target));
                if (rowData && rowData.hasOwnProperty('id')) {
                    popover$.trigger('data.show');
                    popover$.trigger('data.load', rowData);
                }
            });

            $(document).keyup(function (e) {
                if (e.key === "Escape" || e.key === 27) {
                    if (popover$.is(":visible")) {
                        popover$.trigger('data.close');
                    }
                }
            });
        })
    </script>
{% endblock %}
